name: api-websocket-rx
base: core22
version: "1.0.0"
summary: WebSocket API para ctrlX CORE
description: |
  API con WebSocket y FastAPI para conectarse al PLC vÃ­a OPC UA.

grade: stable
confinement: strict

architectures:
  - build-on: amd64
  - build-on: arm64

parts:
  websocket-api:
    plugin: dump
    source: .

    build-packages:
      - python3
      - python3-venv
      - python3-pip
      - python3-dev
      - build-essential

    override-build: |
      craftctl default

      # 0) Limpieza/estructura clara dentro del snap
      mkdir -p "$CRAFT_PART_INSTALL/app"
      mkdir -p "$CRAFT_PART_INSTALL/bin"

      # 1) Copiar TU app (sin depender de stage)
      cp -f main.py "$CRAFT_PART_INSTALL/app/"
      cp -r ws plc utils frontend "$CRAFT_PART_INSTALL/app/" 2>/dev/null || true
      cp -f requirements.snap.txt "$CRAFT_PART_INSTALL/app/"

      # 2) Copiar wrapper
      cp -f bin/websocket-wrapper.sh "$CRAFT_PART_INSTALL/bin/"
      chmod +x "$CRAFT_PART_INSTALL/bin/websocket-wrapper.sh"

      # 3) Crear venv dentro del snap
      python3 -m venv "$CRAFT_PART_INSTALL/venv"
      "$CRAFT_PART_INSTALL/venv/bin/pip" install -U pip setuptools wheel
      "$CRAFT_PART_INSTALL/venv/bin/pip" install -r "$CRAFT_PART_INSTALL/app/requirements.snap.txt"

apps:
  websocket-api:
    command: bin/websocket-wrapper.sh
    daemon: simple
    restart-condition: always
    plugs: [network, network-bind]
